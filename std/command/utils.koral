// ============================================================================
// std.command - Process Utility Functions
// ============================================================================
// Provides: current_pid, send_signal, kill_process, is_alive,
//           run_command, run_command_output
// Access via: using std.command
// NOTE: exit, abort, args stay in std, NOT migrated here.
// ============================================================================

// ============================================================================
// FFI Declarations
// ============================================================================

/// Get the current process PID.
private foreign let koral_getpid() UInt32

/// Send a signal to a process. Returns 0 on success, non-zero on failure.
private foreign let koral_send_signal(pid UInt32, signal Int32) Int32

/// Check if a process is alive. Returns 1 if alive, 0 if not.
private foreign let koral_is_alive(pid UInt32) Int32

/// Get pointer to errno value.
/// Reuse errno helpers from std.os to avoid cross-module symbol ambiguity.

// ============================================================================
// Helpers
// ============================================================================

/// Get the last OS error as a String.
private let get_last_error() String = {
    os.last_error_message()
}

// ============================================================================
// Process Utility Functions
// ============================================================================

/// Get the current process PID.
public let current_pid() UInt32 = koral_getpid()

/// Send a signal to the process with the given PID (Unix).
/// On Windows, SIGTERM/SIGKILL calls TerminateProcess; other signals return an error.
public let send_signal(pid UInt32, signal Int) [Void]Result = {
    let result = koral_send_signal(pid, (Int32)signal)
    if result <> 0 then {
        return [Void]Result.Error(ref get_last_error())
    }
    [Void]Result.Ok({})
}

/// Force-kill the process with the given PID (equivalent to send_signal(pid, SIGKILL=9)).
public let kill_process(pid UInt32) [Void]Result = send_signal(pid, 9)

/// Check whether the process with the given PID is still alive.
public let is_alive(pid UInt32) Bool = koral_is_alive(pid) <> 0

/// Convenience: synchronously execute a command and return only the exit status.
/// Internally uses Command.new(program).with_args(args).run().
public let run_command(program String, args [String]List) [ExitStatus]Result = {
    let mut cmd = Command.new(program)
    cmd = cmd.with_args(args)
    cmd.run()
}

/// Convenience: synchronously execute a command and capture stdout/stderr.
/// Internally uses Command.new(program).with_args(args).run_output().
public let run_command_output(program String, args [String]List) [CommandOutput]Result = {
    let mut cmd = Command.new(program)
    cmd = cmd.with_args(args)
    cmd.run_output()
}
