// ============================================================================
// std.math - Floating Point Module
// ============================================================================

// ============================================================================
// Float64 FFI Declarations
// ============================================================================
foreign let __koral_f64_sqrt(x Float64) Float64
foreign let __koral_f64_cbrt(x Float64) Float64
foreign let __koral_f64_pow(x Float64, y Float64) Float64
foreign let __koral_f64_hypot(x Float64, y Float64) Float64
foreign let __koral_f64_exp(x Float64) Float64
foreign let __koral_f64_exp2(x Float64) Float64
foreign let __koral_f64_expm1(x Float64) Float64
foreign let __koral_f64_log(x Float64) Float64
foreign let __koral_f64_log2(x Float64) Float64
foreign let __koral_f64_log10(x Float64) Float64
foreign let __koral_f64_log1p(x Float64) Float64
foreign let __koral_f64_sin(x Float64) Float64
foreign let __koral_f64_cos(x Float64) Float64
foreign let __koral_f64_tan(x Float64) Float64
foreign let __koral_f64_asin(x Float64) Float64
foreign let __koral_f64_acos(x Float64) Float64
foreign let __koral_f64_atan(x Float64) Float64
foreign let __koral_f64_atan2(y Float64, x Float64) Float64
foreign let __koral_f64_sinh(x Float64) Float64
foreign let __koral_f64_cosh(x Float64) Float64
foreign let __koral_f64_tanh(x Float64) Float64
foreign let __koral_f64_asinh(x Float64) Float64
foreign let __koral_f64_acosh(x Float64) Float64
foreign let __koral_f64_atanh(x Float64) Float64
foreign let __koral_f64_floor(x Float64) Float64
foreign let __koral_f64_ceil(x Float64) Float64
foreign let __koral_f64_round(x Float64) Float64
foreign let __koral_f64_trunc(x Float64) Float64
foreign let __koral_f64_fabs(x Float64) Float64
foreign let __koral_f64_copysign(x Float64, y Float64) Float64
foreign let __koral_f64_fmod(x Float64, y Float64) Float64
foreign let __koral_f64_fma(x Float64, y Float64, z Float64) Float64
foreign let __koral_f64_erf(x Float64) Float64
foreign let __koral_f64_erfc(x Float64) Float64
foreign let __koral_f64_tgamma(x Float64) Float64
foreign let __koral_f64_lgamma(x Float64) Float64

// ============================================================================
// Float32 FFI Declarations
// ============================================================================
foreign let __koral_f32_sqrt(x Float32) Float32
foreign let __koral_f32_cbrt(x Float32) Float32
foreign let __koral_f32_pow(x Float32, y Float32) Float32
foreign let __koral_f32_hypot(x Float32, y Float32) Float32
foreign let __koral_f32_exp(x Float32) Float32
foreign let __koral_f32_exp2(x Float32) Float32
foreign let __koral_f32_expm1(x Float32) Float32
foreign let __koral_f32_log(x Float32) Float32
foreign let __koral_f32_log2(x Float32) Float32
foreign let __koral_f32_log10(x Float32) Float32
foreign let __koral_f32_log1p(x Float32) Float32
foreign let __koral_f32_sin(x Float32) Float32
foreign let __koral_f32_cos(x Float32) Float32
foreign let __koral_f32_tan(x Float32) Float32
foreign let __koral_f32_asin(x Float32) Float32
foreign let __koral_f32_acos(x Float32) Float32
foreign let __koral_f32_atan(x Float32) Float32
foreign let __koral_f32_atan2(y Float32, x Float32) Float32
foreign let __koral_f32_sinh(x Float32) Float32
foreign let __koral_f32_cosh(x Float32) Float32
foreign let __koral_f32_tanh(x Float32) Float32
foreign let __koral_f32_asinh(x Float32) Float32
foreign let __koral_f32_acosh(x Float32) Float32
foreign let __koral_f32_atanh(x Float32) Float32
foreign let __koral_f32_floor(x Float32) Float32
foreign let __koral_f32_ceil(x Float32) Float32
foreign let __koral_f32_round(x Float32) Float32
foreign let __koral_f32_trunc(x Float32) Float32
foreign let __koral_f32_fabs(x Float32) Float32
foreign let __koral_f32_copysign(x Float32, y Float32) Float32
foreign let __koral_f32_fmod(x Float32, y Float32) Float32
foreign let __koral_f32_fma(x Float32, y Float32, z Float32) Float32
foreign let __koral_f32_erf(x Float32) Float32
foreign let __koral_f32_erfc(x Float32) Float32
foreign let __koral_f32_tgamma(x Float32) Float32
foreign let __koral_f32_lgamma(x Float32) Float32

// ============================================================================
// given Float64 Implementation
// ============================================================================
given Float64 {
    protected sqrt_impl(x Self) Self = __koral_f64_sqrt(x)
    protected cbrt_impl(x Self) Self = __koral_f64_cbrt(x)
    protected pow_impl(x Self, y Self) Self = __koral_f64_pow(x, y)
    protected hypot_impl(x Self, y Self) Self = __koral_f64_hypot(x, y)
    protected exp_impl(x Self) Self = __koral_f64_exp(x)
    protected exp2_impl(x Self) Self = __koral_f64_exp2(x)
    protected exp_m1_impl(x Self) Self = __koral_f64_expm1(x)
    protected ln_impl(x Self) Self = __koral_f64_log(x)
    protected log2_impl(x Self) Self = __koral_f64_log2(x)
    protected log10_impl(x Self) Self = __koral_f64_log10(x)
    protected ln_1p_impl(x Self) Self = __koral_f64_log1p(x)
    protected sin_impl(x Self) Self = __koral_f64_sin(x)
    protected cos_impl(x Self) Self = __koral_f64_cos(x)
    protected tan_impl(x Self) Self = __koral_f64_tan(x)
    protected asin_impl(x Self) Self = __koral_f64_asin(x)
    protected acos_impl(x Self) Self = __koral_f64_acos(x)
    protected atan_impl(x Self) Self = __koral_f64_atan(x)
    protected atan2_impl(y Self, x Self) Self = __koral_f64_atan2(y, x)
    protected sinh_impl(x Self) Self = __koral_f64_sinh(x)
    protected cosh_impl(x Self) Self = __koral_f64_cosh(x)
    protected tanh_impl(x Self) Self = __koral_f64_tanh(x)
    protected asinh_impl(x Self) Self = __koral_f64_asinh(x)
    protected acosh_impl(x Self) Self = __koral_f64_acosh(x)
    protected atanh_impl(x Self) Self = __koral_f64_atanh(x)
    protected floor_impl(x Self) Self = __koral_f64_floor(x)
    protected ceil_impl(x Self) Self = __koral_f64_ceil(x)
    protected round_impl(x Self) Self = __koral_f64_round(x)
    protected trunc_impl(x Self) Self = __koral_f64_trunc(x)
    protected fabs_impl(x Self) Self = __koral_f64_fabs(x)
    protected copysign_impl(x Self, sign Self) Self = __koral_f64_copysign(x, sign)
    protected fmod_impl(x Self, y Self) Self = __koral_f64_fmod(x, y)
    protected fma_impl(x Self, mul Self, add Self) Self = __koral_f64_fma(x, mul, add)
    protected erf_impl(x Self) Self = __koral_f64_erf(x)
    protected erfc_impl(x Self) Self = __koral_f64_erfc(x)
    protected tgamma_impl(x Self) Self = __koral_f64_tgamma(x)
    protected lgamma_impl(x Self) Self = __koral_f64_lgamma(x)

    protected signum_impl(x Self) Self = {
        if x.is_nan() then Float64.nan()
        else if x > 0.0 then 1.0
        else if x < 0.0 then -1.0
        else 0.0
    }

    protected fract_impl(x Self) Self = x - __koral_f64_trunc(x)
    protected lerp_impl(a Self, b Self, t Self) Self = a + t * (b - a)

    protected powi_impl(base Self, exp Int) Self = {
        if exp < 0 then {
            1.0 / Float64.powi_impl(base, -exp)
        } else {
            let mut result = 1.0
            let mut b = base
            let mut e = exp
            while e > 0 then {
                if e % 2 == 1 then { result = result * b }
                b = b * b
                e = e / 2
            }
            result
        }
    }

    protected to_radians_impl(x Self) Self = x * (Float64.pi_impl() / 180.0)
    protected to_degrees_impl(x Self) Self = x * (180.0 / Float64.pi_impl())
    protected log_impl(x Self, base Self) Self = __koral_f64_log(x) / __koral_f64_log(base)

    protected pi_impl() Self = 3.14159265358979323846
    protected e_impl() Self = 2.71828182845904523536
    protected tau_impl() Self = 6.28318530717958647692
    protected ln2_impl() Self = 0.693147180559945309417
    protected ln10_impl() Self = 2.30258509299404568402
    protected sqrt2_impl() Self = 1.41421356237309504880
}

// ============================================================================
// given Float32 Implementation
// ============================================================================
given Float32 {
    protected sqrt_impl(x Self) Self = __koral_f32_sqrt(x)
    protected cbrt_impl(x Self) Self = __koral_f32_cbrt(x)
    protected pow_impl(x Self, y Self) Self = __koral_f32_pow(x, y)
    protected hypot_impl(x Self, y Self) Self = __koral_f32_hypot(x, y)
    protected exp_impl(x Self) Self = __koral_f32_exp(x)
    protected exp2_impl(x Self) Self = __koral_f32_exp2(x)
    protected exp_m1_impl(x Self) Self = __koral_f32_expm1(x)
    protected ln_impl(x Self) Self = __koral_f32_log(x)
    protected log2_impl(x Self) Self = __koral_f32_log2(x)
    protected log10_impl(x Self) Self = __koral_f32_log10(x)
    protected ln_1p_impl(x Self) Self = __koral_f32_log1p(x)
    protected sin_impl(x Self) Self = __koral_f32_sin(x)
    protected cos_impl(x Self) Self = __koral_f32_cos(x)
    protected tan_impl(x Self) Self = __koral_f32_tan(x)
    protected asin_impl(x Self) Self = __koral_f32_asin(x)
    protected acos_impl(x Self) Self = __koral_f32_acos(x)
    protected atan_impl(x Self) Self = __koral_f32_atan(x)
    protected atan2_impl(y Self, x Self) Self = __koral_f32_atan2(y, x)
    protected sinh_impl(x Self) Self = __koral_f32_sinh(x)
    protected cosh_impl(x Self) Self = __koral_f32_cosh(x)
    protected tanh_impl(x Self) Self = __koral_f32_tanh(x)
    protected asinh_impl(x Self) Self = __koral_f32_asinh(x)
    protected acosh_impl(x Self) Self = __koral_f32_acosh(x)
    protected atanh_impl(x Self) Self = __koral_f32_atanh(x)
    protected floor_impl(x Self) Self = __koral_f32_floor(x)
    protected ceil_impl(x Self) Self = __koral_f32_ceil(x)
    protected round_impl(x Self) Self = __koral_f32_round(x)
    protected trunc_impl(x Self) Self = __koral_f32_trunc(x)
    protected fabs_impl(x Self) Self = __koral_f32_fabs(x)
    protected copysign_impl(x Self, sign Self) Self = __koral_f32_copysign(x, sign)
    protected fmod_impl(x Self, y Self) Self = __koral_f32_fmod(x, y)
    protected fma_impl(x Self, mul Self, add Self) Self = __koral_f32_fma(x, mul, add)
    protected erf_impl(x Self) Self = __koral_f32_erf(x)
    protected erfc_impl(x Self) Self = __koral_f32_erfc(x)
    protected tgamma_impl(x Self) Self = __koral_f32_tgamma(x)
    protected lgamma_impl(x Self) Self = __koral_f32_lgamma(x)

    protected signum_impl(x Self) Self = {
        if x.is_nan() then Float32.nan()
        else if x > 0.0 then 1.0
        else if x < 0.0 then -1.0
        else 0.0
    }

    protected fract_impl(x Self) Self = x - __koral_f32_trunc(x)
    protected lerp_impl(a Self, b Self, t Self) Self = a + t * (b - a)

    protected powi_impl(base Self, exp Int) Self = {
        if exp < 0 then {
            1.0 / Float32.powi_impl(base, -exp)
        } else {
            let mut result Float32 = 1.0
            let mut b = base
            let mut e = exp
            while e > 0 then {
                if e % 2 == 1 then { result = result * b }
                b = b * b
                e = e / 2
            }
            result
        }
    }

    protected to_radians_impl(x Self) Self = x * (Float32.pi_impl() / 180.0)
    protected to_degrees_impl(x Self) Self = x * (180.0 / Float32.pi_impl())
    protected log_impl(x Self, base Self) Self = __koral_f32_log(x) / __koral_f32_log(base)

    protected pi_impl() Self = 3.14159274
    protected e_impl() Self = 2.71828175
    protected tau_impl() Self = 6.28318548
    protected ln2_impl() Self = 0.693147182
    protected ln10_impl() Self = 2.30258512
    protected sqrt2_impl() Self = 1.41421354
}

// ============================================================================
// Floating Point Generic Free Functions
// ============================================================================

// 幂与根
public let [T Floating]sqrt(x T) T = T.sqrt_impl(x)
public let [T Floating]cbrt(x T) T = T.cbrt_impl(x)
public let [T Floating]pow(base T, exp T) T = T.pow_impl(base, exp)
public let [T Floating]powi(base T, exp Int) T = T.powi_impl(base, exp)
public let [T Floating]hypot(x T, y T) T = T.hypot_impl(x, y)

// 指数与对数
public let [T Floating]exp(x T) T = T.exp_impl(x)
public let [T Floating]exp2(x T) T = T.exp2_impl(x)
public let [T Floating]exp_m1(x T) T = T.exp_m1_impl(x)
public let [T Floating]ln(x T) T = T.ln_impl(x)
public let [T Floating]log2(x T) T = T.log2_impl(x)
public let [T Floating]log10(x T) T = T.log10_impl(x)
public let [T Floating]ln_1p(x T) T = T.ln_1p_impl(x)

// 三角函数
public let [T Floating]sin(x T) T = T.sin_impl(x)
public let [T Floating]cos(x T) T = T.cos_impl(x)
public let [T Floating]tan(x T) T = T.tan_impl(x)
public let [T Floating]asin(x T) T = T.asin_impl(x)
public let [T Floating]acos(x T) T = T.acos_impl(x)
public let [T Floating]atan(x T) T = T.atan_impl(x)
public let [T Floating]atan2(y T, x T) T = T.atan2_impl(y, x)

// 双曲函数
public let [T Floating]sinh(x T) T = T.sinh_impl(x)
public let [T Floating]cosh(x T) T = T.cosh_impl(x)
public let [T Floating]tanh(x T) T = T.tanh_impl(x)
public let [T Floating]asinh(x T) T = T.asinh_impl(x)
public let [T Floating]acosh(x T) T = T.acosh_impl(x)
public let [T Floating]atanh(x T) T = T.atanh_impl(x)

// 取整与符号
public let [T Floating]floor(x T) T = T.floor_impl(x)
public let [T Floating]ceil(x T) T = T.ceil_impl(x)
public let [T Floating]round(x T) T = T.round_impl(x)
public let [T Floating]trunc(x T) T = T.trunc_impl(x)
public let [T Floating]fract(x T) T = T.fract_impl(x)
public let [T Floating]fabs(x T) T = T.fabs_impl(x)
public let [T Floating]signum(x T) T = T.signum_impl(x)
public let [T Floating]copysign(x T, sign T) T = T.copysign_impl(x, sign)

// 浮点取模
public let [T Floating]fmod(x T, y T) T = T.fmod_impl(x, y)

// 融合乘加与线性插值
public let [T Floating]fma(x T, mul T, add T) T = T.fma_impl(x, mul, add)
public let [T Floating]lerp(a T, b T, t T) T = T.lerp_impl(a, b, t)

// 特殊函数
public let [T Floating]erf(x T) T = T.erf_impl(x)
public let [T Floating]erfc(x T) T = T.erfc_impl(x)
public let [T Floating]tgamma(x T) T = T.tgamma_impl(x)
public let [T Floating]lgamma(x T) T = T.lgamma_impl(x)

// 角度转换
public let [T Floating]to_radians(x T) T = T.to_radians_impl(x)
public let [T Floating]to_degrees(x T) T = T.to_degrees_impl(x)

// 任意底对数
public let [T Floating]log(x T, base T) T = T.log_impl(x, base)

// 数学常量
public let [T Floating]pi() T = T.pi_impl()
public let [T Floating]e() T = T.e_impl()
public let [T Floating]tau() T = T.tau_impl()
public let [T Floating]ln2() T = T.ln2_impl()
public let [T Floating]ln10() T = T.ln10_impl()
public let [T Floating]sqrt2() T = T.sqrt2_impl()
