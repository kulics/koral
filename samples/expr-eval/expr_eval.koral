// 表达式求值器 - 入口文件

public using "./types"
public using "./frontend"
public using "./backend"

// REPL 类型
public type REPL(mut evaluator backend.Evaluator)

given REPL {
    public new() Self = REPL(backend.Evaluator.new())

    // 显示欢迎信息
    private show_welcome(self) Void = {
        println("Expression Evaluator v1.0")
        println("Type 'help' for available commands, 'quit' to exit.")
        println("")
    }

    // 显示帮助信息
    private show_help(self) Void = {
        println("Commands:")
        println("  help   - Show this help message")
        println("  vars   - List all defined variables")
        println("  clear  - Clear all variables")
        println("  quit   - Exit the program")
        println("  exit   - Exit the program")
        println("")
        println("Operators: + - * / % ^ (power)")
        println("Functions: abs, sqrt, min, max, floor, ceil, round,")
        println("          sin, cos, tan, ln, log2, log10, exp")
        println("Variables: x = 10 (assignment), x (reference)")
    }

    // 处理单行输入
    private process_line(self ref, line String) Bool = {
        // 检查命令
        if line == "quit" or line == "exit" then {
            println("Goodbye!")
            return false
        }
        
        if line == "help" then {
            self.show_help()
            return true
        }
        
        if line == "vars" then {
            self.evaluator.list_vars()
            return true
        }
        
        if line == "clear" then {
            self.evaluator.clear_env()
            println("Variables cleared.")
            return true
        }
        
        // 空行跳过
        if line.is_empty() then {
            return true
        }
        
        // 解析并求值表达式
        let lexer = frontend.Lexer.new(line)
        when lexer.tokenize() in {
            .Ok(tokens) then {
                let parser = frontend.Parser.new(tokens)
                when parser.parse() in {
                    .Ok(expr) then {
                        when self.evaluator.eval(expr) in {
                            .Ok(v) then println(v.to_string()),
                            .Error(e) then {
                                let s = String.zero()
                                s.push_string("Error: ")
                                s.push_string(e.message())
                                println(s)
                            },
                        }
                    },
                    .Error(e) then {
                        let s = String.zero()
                        s.push_string("Parse error: ")
                        s.push_string(e.message())
                        println(s)
                    },
                }
            },
            .Error(e) then {
                let s = String.zero()
                s.push_string("Lexer error: ")
                s.push_string(e.message())
                println(s)
            },
        }
        
        return true
    }

    // 运行 REPL 主循环
    public run(self ref) Void = {
        self.show_welcome()
        
        let mut running = true
        while running then {
            print("> ")
            when scanln() in {
                .Some(line) then {
                    running = self.process_line(line)
                },
                .None then {
                    // EOF
                    println("")
                    println("Goodbye!")
                    running = false
                },
            }
        }
    }
}

public let main() Void = {
    let repl = REPL.new()
    repl.run()
}
