// 表达式求值器 - 数学函数实现

// sqrt - 使用牛顿迭代法计算平方根
public let math_sqrt(x Float64) Float64 = {
    if x < 0.0 then {
        // 返回 NaN (通过 0.0/0.0)
        0.0 / 0.0
    } else if x == 0.0 then {
        0.0
    } else {
        // 牛顿迭代法
        let mut guess = x / 2.0
        let mut prev = 0.0
        let epsilon = 0.0000000001
        
        // 迭代直到收敛
        while true then {
            prev = guess
            guess = (guess + x / guess) / 2.0
            
            // 检查收敛
            let diff = guess - prev
            let abs_diff = if diff < 0.0 then 0.0 - diff else diff
            if abs_diff < epsilon then {
                return guess
            }
        }
        guess
    }
}

// pow - 计算幂运算
public let math_pow(base Float64, exp Float64) Float64 = {
    if exp == 0.0 then {
        1.0
    } else if base == 0.0 then {
        0.0
    } else if exp == 1.0 then {
        base
    } else {
        // 检查指数是否为整数
        let exp_int = (Int)exp
        if (Float64)exp_int == exp then {
            // 整数幂：使用快速幂算法
            int_pow(base, exp_int)
        } else {
            // 非整数幂：使用 exp(exp * ln(base)) 近似
            // 简化实现：只支持整数幂
            // 对于非整数幂，返回近似值
            let int_part = (Int)exp
            let frac_part = exp - (Float64)int_part
            
            // 计算整数部分
            let int_result = int_pow(base, int_part)
            
            // 对于小数部分，使用线性插值近似
            // 这是一个简化实现，精度有限
            if frac_part == 0.0 then {
                int_result
            } else {
                // 使用 base^(n+f) ≈ base^n * (1 + f * ln(base))
                // 这里用更简单的近似
                let next_int = int_pow(base, int_part + 1)
                int_result + frac_part * (next_int - int_result)
            }
        }
    }
}

// 整数幂运算（快速幂）
let int_pow(base Float64, exp Int) Float64 = {
    if exp < 0 then {
        1.0 / int_pow(base, 0 - exp)
    } else if exp == 0 then {
        1.0
    } else {
        let mut result = 1.0
        let mut b = base
        let mut e = exp
        while e > 0 then {
            if e % 2 == 1 then {
                result = result * b
            }
            b = b * b
            e = e / 2
        }
        result
    }
}


// floor - 向下取整
public let math_floor(x Float64) Int = {
    let int_part = (Int)x
    if x >= 0.0 then {
        int_part
    } else {
        // 负数：如果有小数部分，需要减1
        if (Float64)int_part == x then {
            int_part
        } else {
            int_part - 1
        }
    }
}

// ceil - 向上取整
public let math_ceil(x Float64) Int = {
    let int_part = (Int)x
    if x <= 0.0 then {
        int_part
    } else {
        // 正数：如果有小数部分，需要加1
        if (Float64)int_part == x then {
            int_part
        } else {
            int_part + 1
        }
    }
}

// round - 四舍五入
public let math_round(x Float64) Int = {
    if x >= 0.0 then {
        math_floor(x + 0.5)
    } else {
        math_ceil(x - 0.5)
    }
}

// abs - 绝对值 (Float64)
public let math_abs_float(x Float64) Float64 = {
    if x < 0.0 then 0.0 - x else x
}

// abs - 绝对值 (Int)
public let math_abs_int(x Int) Int = {
    if x < 0 then 0 - x else x
}
