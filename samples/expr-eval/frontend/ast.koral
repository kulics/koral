// 表达式求值器 - AST 类型定义

public type BinaryOperator {
    Add(),
    Sub(),
    Mul(),
    Div(),
    Mod(),
    Pow(),
}

given BinaryOperator {
    public to_string(self) String = when self is {
        .Add then "+",
        .Sub then "-",
        .Mul then "*",
        .Div then "/",
        .Mod then "%",
        .Pow then "**",
    }
}

public type UnaryOperator {
    Neg(),
}

given UnaryOperator {
    public to_string(self) String = when self is {
        .Neg then "-",
    }
}

public type Expr {
    Number(value types.Value),
    Variable(name String),
    BinaryOp(op BinaryOperator, left Expr ref, right Expr ref),
    UnaryOp(op UnaryOperator, operand Expr ref),
    FunctionCall(name String, args [Expr ref]List),
    Assignment(name String, value Expr ref),
}

given Expr {
    public to_string(self) String = when self is {
        .Number(v) then v.to_string(),
        .Variable(name) then name,
        .BinaryOp(op, left, right) then {
            let s = String.zero()
            s.push('(')
            s.push_string(left.to_string())
            s.push(' ')
            s.push_string(op.to_string())
            s.push(' ')
            s.push_string(right.to_string())
            s.push(')')
            s
        },
        .UnaryOp(op, operand) then {
            let s = String.zero()
            s.push('(')
            s.push_string(op.to_string())
            s.push_string(operand.to_string())
            s.push(')')
            s
        },
        .FunctionCall(name, args) then {
            let s = String.zero()
            s.push_string(name)
            s.push('(')
            let mut i = 0
            for arg = args then {
                if i > 0 then {
                    s.push_string(", ")
                }
                s.push_string(arg.to_string())
                i += 1
            }
            s.push(')')
            s
        },
        .Assignment(name, value) then {
            let s = String.zero()
            s.push_string(name)
            s.push_string(" = ")
            s.push_string(value.to_string())
            s
        },
    }
}
