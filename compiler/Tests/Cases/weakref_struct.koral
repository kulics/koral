// EXPECT: WeakRef Struct Test:
// EXPECT: Node value: 42
// EXPECT: Weak ref in struct works!
// EXPECT: Test passed!

// A struct containing a weak reference
type Node(value Int, parent Int weakref)

let testWeakRefStruct() Int = {
    print_line("WeakRef Struct Test:")
    
    // Create a parent node
    let parentRef Int ref = ref 42
    
    // Create a weak reference to parent
    let weakParent = downgrade_ref(parentRef)
    
    // Create a node with the weak reference
    let node = Node(100, weakParent)
    
    // Access the weak reference from the struct
    let upgraded_opt = upgrade_ref(node.parent)
    when upgraded_opt is {
        .Some(parent) then {
            print("Node value: ")
            print_line(deref parent)
            print_line("Weak ref in struct works!")
        },
        .None then {
            print_line("Parent was released")
        },
    }
    
    print_line("Test passed!")
    0
}

let main() Int = {
    testWeakRefStruct()
    0
}
