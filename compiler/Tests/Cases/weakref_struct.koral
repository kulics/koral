// EXPECT: WeakRef Struct Test:
// EXPECT: Node value: 42
// EXPECT: Weak ref in struct works!
// EXPECT: Test passed!

// A struct containing a weak reference
type Node(value Int, parent Int weakref)

let testWeakRefStruct() Int = {
    println("WeakRef Struct Test:")
    
    // Create a parent node
    let parentRef Int ref = ref 42
    
    // Create a weak reference to parent
    let weakParent = downgrade_ref(parentRef)
    
    // Create a node with the weak reference
    let node = Node(100, weakParent)
    
    // Access the weak reference from the struct
    let upgraded_opt = upgrade_ref(node.parent)
    when upgraded_opt in {
        .Some(parent) then {
            print("Node value: ")
            println(deref parent)
            println("Weak ref in struct works!")
        },
        .None then {
            println("Parent was released")
        },
    }
    
    println("Test passed!")
    yield 0
}

let main() Int = {
    testWeakRefStruct()
    yield 0
}
