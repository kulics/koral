// Test drop of intermediate values in chain calls
// Intermediate values are dropped immediately after each method call
// EXPECT: Creating Wrapper 1
// EXPECT: Transform to 2
// EXPECT: Drop Wrapper 1
// EXPECT: Transform to 4
// EXPECT: Drop Wrapper 2
// EXPECT: Drop Wrapper 4
// EXPECT: Final value: 4
// EXPECT: All chain call drop tests passed

type Wrapper(id Int)

given Wrapper {
    __drop(self ref) Void = {
        print("Drop Wrapper ")
        print_line(self.id)
    }
    
    transform(self ref) Wrapper = {
        let new_id = self.id * 2
        print("Transform to ")
        print_line(new_id)
        Wrapper(new_id)
    }
    
    get_value(self ref) Int = {
        self.id
    }
}

let create_wrapper(id Int) Wrapper = {
    print("Creating Wrapper ")
    print_line(id)
    Wrapper(id)
}

let test_chain_call() Void = {
    // Chain call: create_wrapper(1).transform().transform().get_value()
    // Each intermediate Wrapper is dropped after its method is called
    // - Wrapper(1) is dropped after first transform() returns Wrapper(2)
    // - Wrapper(2) is dropped after second transform() returns Wrapper(4)
    // - Wrapper(4) is dropped after get_value() returns 4
    let result = create_wrapper(1).transform().transform().get_value()
    print("Final value: ")
    print_line(result)
}

let main() Int = {
    test_chain_call()
    
    print_line("All chain call drop tests passed")
    0
}
