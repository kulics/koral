// Test drop of intermediate values in chain calls
// Methods take self by value, so each call consumes a copy.
// Drops happen at end of scope for each intermediate value.
// EXPECT: Creating Wrapper 1
// EXPECT: Transform to 2
// EXPECT: Drop Wrapper 1
// EXPECT: Transform to 4
// EXPECT: Drop Wrapper 2
// EXPECT: Drop Wrapper 4
// EXPECT: Final value: 4
// EXPECT: All chain call drop tests passed

type Wrapper(id Int)

given Wrapper {
    __drop(self ref) Void = {
        print("Drop Wrapper ")
        println(self.id)
    }
    
    transform(self) Wrapper = {
        let new_id = self.id * 2
        print("Transform to ")
        println(new_id)
        yield Wrapper(new_id)
    }
    
    get_value(self) Int = {
        yield self.id
    }
}

let create_wrapper(id Int) Wrapper = {
    print("Creating Wrapper ")
    println(id)
    yield Wrapper(id)
}

let test_chain_call() Void = {
    let result = create_wrapper(1).transform().transform().get_value()
    print("Final value: ")
    println(result)
}

let main() Int = {
    test_chain_call()
    
    println("All chain call drop tests passed")
    yield 0
}
