// EXPECT: in_timezone_ok
// EXPECT: in_utc_ok
// EXPECT: add_duration_ok
// EXPECT: add_sub_roundtrip_ok
// EXPECT: eq_across_tz_ok
// EXPECT: sub_point_ok
// EXPECT: from_unix_roundtrip_ok

using * in "std/time"

let main() Int = {
    let epoch = DateTime.epoch()
    let utc = TimeZone.utc()

    // in_timezone preserves unix_seconds
    let r1 = TimeZone.from_offset(Duration.from_seconds(3600))
    if r1 is .Ok(tz) then {
        let converted = epoch.in_timezone(tz)
        assert(converted.to_unix_seconds() == epoch.to_unix_seconds(), "in_tz secs")
    } else {
        assert(false, "tz err")
    }
    println("in_timezone_ok")

    // in_utc timezone equals UTC
    let local_dt = DateTime.from_unix_seconds(1000000)
    let utc_dt = local_dt.in_utc()
    assert(utc_dt.timezone().equals(utc), "in_utc tz")
    println("in_utc_ok")

    // add Duration: epoch + 3600s = unix_seconds 3600
    let dt1 = epoch + Duration.from_seconds(3600)
    assert(dt1.to_unix_seconds() == (Int64)3600, "add 3600")
    println("add_duration_ok")

    // (dt + d) - d roundtrip
    let dt2 = DateTime.from_unix_seconds(1_700_000_000)
    let d = Duration.from_seconds(86400)
    let dt3 = dt2 + d
    let dt4 = dt3 - d
    assert(dt4.to_unix_seconds() == dt2.to_unix_seconds(), "add sub rt")
    println("add_sub_roundtrip_ok")

    // equals across timezones: same instant
    let r2 = TimeZone.from_offset(Duration.from_seconds(28800))
    if r2 is .Ok(tz8) then {
        let dt_utc = DateTime.from_unix_seconds(1_700_000_000)
        let dt_tz8 = dt_utc.in_timezone(tz8)
        assert(dt_utc.equals(dt_tz8), "eq across tz")
        assert(dt_utc.compare(dt_tz8) == 0, "cmp across tz")
    } else {
        assert(false, "tz8 err")
    }
    println("eq_across_tz_ok")

    // sub_point: DateTime - DateTime
    let a = DateTime.from_unix_seconds(1000)
    let b = DateTime.from_unix_seconds(500)
    let diff = a - b
    assert(diff.secs == (Int64)500, "sub_point secs")
    println("sub_point_ok")

    // from_unix_timestamp roundtrip
    let ts = Duration((Int64)1_700_000_000, (Int64)123_456_789)
    let dt5 = DateTime.from_unix_timestamp(ts)
    let ts2 = dt5.to_unix_timestamp()
    assert(ts2.secs == ts.secs, "unix rt secs")
    assert(ts2.nanos == ts.nanos, "unix rt nanos")
    println("from_unix_roundtrip_ok")

    yield 0
}
