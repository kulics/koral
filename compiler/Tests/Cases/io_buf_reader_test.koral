// EXPECT: All BufReader tests passed

using * in "std/io"

let main() Void = {
    // read
    let src1 = ByteBuffer.from_string("hello world")
    let r1 = [ByteBuffer]BufReader.new(src1)
    let mut out = make_bytes(64)
    when r1.read(ref out, ....) in {
        .Ok(_) then {},
        .Error(_) then assert(false, "read error"),
    }

    // read_byte
    let src2 = ByteBuffer.from_string("ABC")
    let r2 = [ByteBuffer]BufReader.new(src2)
    when r2.read_byte() in {
        .Ok(_) then {},
        .Error(_) then assert(false, "read_byte error"),
    }

    // read_until
    let src3 = ByteBuffer.from_string("a|b|c")
    let r3 = [ByteBuffer]BufReader.new(src3)
    let mut out2 = make_bytes(16)
    when r3.read_until(124, ref out2, ....) in {
        .Ok(_) then {},
        .Error(_) then assert(false, "read_until error"),
    }

    // read_line
    let src4 = ByteBuffer.from_string("line1\nline2")
    let r4 = [ByteBuffer]BufReader.new(src4)
    when r4.read_line() in {
        .Ok(_) then {},
        .Error(_) then assert(false, "read_line error"),
    }

    // skip
    let src5 = ByteBuffer.from_string("abcdef")
    let r5 = [ByteBuffer]BufReader.new(src5)
    when r5.skip(2) in {
        .Ok(_) then {},
        .Error(_) then assert(false, "skip error"),
    }

    // constrained Seeker impl (R: Reader and Seeker)
    let src6 = ByteBuffer.from_string("abcdef")
    let r6 = [ByteBuffer]BufReader.with_capacity(src6, 2)
    let p1 = r6.seek(SeekPos.Start(2)).unwrap()
    assert(p1 == (UInt64)2, "seek start")
    let p2 = r6.seek(SeekPos.Current(1)).unwrap()
    assert(p2 == (UInt64)3, "seek current")
    let p3 = r6.seek(SeekPos.End(-1)).unwrap()
    assert(p3 == (UInt64)5, "seek end")

    println("All BufReader tests passed")
}
