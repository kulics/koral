// EXPECT: String tests passed

let test_literal_basics() Void = {
    let s = "hi"
    let h UInt8 = 104
    let i UInt8 = 105
    let zero UInt8 = 0
    assert(s.count_byte() == 2, "literal count")
    assert(not s.is_empty(), "literal not empty")
    assert(s.get_byte(0) == h, "literal byte h")
    assert(s.get_byte(1) == i, "literal byte i")
    assert(s.get_byte(s.count_byte()) == zero, "literal trailing zero")
}

let test_push_and_set() Void = {
    let mut s = "a"
    let b UInt8 = 98// 'b'
    let c UInt8 = 99// 'c'
    let zero UInt8 = 0
    s.push_byte(b)
    assert(s.count_byte() == 2, "push count")
    s.set_byte(1, c)
    assert(s.get_byte(1) == c, "set byte")
    assert(s.get_byte(s.count_byte()) == zero, "push trailing zero")
}

let test_push_string() Void = {
    let mut s = "ab"
    let t = "XYZ"
    let z UInt8 = 90// 'Z'
    s.push(t)
    assert(s.count_byte() == 5, "push string count")
    assert(s.get_byte(4) == z, "push string byte")
}

let test_copy_on_write() Void = {
    let mut a = "hi"
    let b = a// Copy should share storage
    let x UInt8 = 120// 'x'
    let bang UInt8 = 33// '!'
    let h UInt8 = 104// 'h'

    a.set_byte(0, x)// Should detach storage
    a.push_byte(bang)

    assert(a.count_byte() == 3, "a mutated count")
    assert(a.get_byte(0) == x, "a mutated byte")

    // Original copy remains unchanged
    assert(b.count_byte() == 2, "b preserved count")
    assert(b.get_byte(0) == h, "b preserved byte")
}

let main() Void = {
    test_literal_basics()
    test_push_and_set()
    test_push_string()
    test_copy_on_write()
    print_string("String tests passed")
}
