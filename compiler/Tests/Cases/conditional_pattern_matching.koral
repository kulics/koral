// Test conditional pattern matching: if expr is pattern then ... else ...
// and while expr is pattern then ...
// EXPECT: test_if_is_some: PASS
// EXPECT: test_if_is_none: PASS
// EXPECT: test_if_is_with_binding: PASS
// EXPECT: test_if_is_with_else: PASS
// EXPECT: test_if_is_comparison: PASS
// EXPECT: test_if_is_combinator: PASS
// EXPECT: test_while_is_iterator: PASS
// EXPECT: test_nested_if_is: PASS
// EXPECT: All conditional pattern matching tests passed!

type MyOption {
    None(),
    Some(val Int),
}

type MyIterator(mut current Int, max Int)

given MyIterator {
    next(self ref) MyOption = {
        if self.current < self.max then {
            let v = self.current
            self.current = self.current + 1
            MyOption.Some(v)
        } else {
            MyOption.None()
        }
    }
}

// Test if is with Some pattern
let test_if_is_some() Int = {
    let opt = MyOption.Some(42)
    if opt is .Some(v) then v else 0
}

// Test if is with None pattern
let test_if_is_none() Int = {
    let opt = MyOption.None()
    if opt is .None then 1 else 0
}

// Test if is with variable binding in scope
let test_if_is_with_binding() Int = {
    let opt = MyOption.Some(10)
    let mut result = 0
    if opt is .Some(v) then {
        result = v * 2  // v should be 10, result = 20
    }
    result
}

// Test if is with else branch
let test_if_is_with_else() Int = {
    let opt = MyOption.None()
    if opt is .Some(v) then v else 99
}

// Test if is with comparison pattern
let test_if_is_comparison() Int = {
    let x = 15
    if x is > 10 then 1 else 0
}

// Test if is with pattern combinator
let test_if_is_combinator() Int = {
    let x = 5
    if x is > 0 and < 10 then 1 else 0
}

// Test while is with iterator pattern
let test_while_is_iterator() Int = {
    let mut iter = MyIterator(0, 5)
    let mut sum = 0
    while iter.next() is .Some(v) then {
        sum = sum + v
    }
    sum  // 0 + 1 + 2 + 3 + 4 = 10
}

// Test nested if is patterns
let test_nested_if_is() Int = {
    let outer = MyOption.Some(42)
    if outer is .Some(v) then {
        v  // v is 42
    } else {
        0
    }
}

let main() Int = {
    // Test if is with Some
    if test_if_is_some() == 42 then {
        print_line("test_if_is_some: PASS")
    } else {
        print_line("test_if_is_some: FAIL")
        return 1
    }
    
    // Test if is with None
    if test_if_is_none() == 1 then {
        print_line("test_if_is_none: PASS")
    } else {
        print_line("test_if_is_none: FAIL")
        return 1
    }
    
    // Test if is with binding
    if test_if_is_with_binding() == 20 then {
        print_line("test_if_is_with_binding: PASS")
    } else {
        print_line("test_if_is_with_binding: FAIL")
        return 1
    }
    
    // Test if is with else
    if test_if_is_with_else() == 99 then {
        print_line("test_if_is_with_else: PASS")
    } else {
        print_line("test_if_is_with_else: FAIL")
        return 1
    }
    
    // Test if is with comparison
    if test_if_is_comparison() == 1 then {
        print_line("test_if_is_comparison: PASS")
    } else {
        print_line("test_if_is_comparison: FAIL")
        return 1
    }
    
    // Test if is with combinator
    if test_if_is_combinator() == 1 then {
        print_line("test_if_is_combinator: PASS")
    } else {
        print_line("test_if_is_combinator: FAIL")
        return 1
    }
    
    // Test while is with iterator
    if test_while_is_iterator() == 10 then {
        print_line("test_while_is_iterator: PASS")
    } else {
        print_line("test_while_is_iterator: FAIL")
        return 1
    }
    
    // Test nested if is
    if test_nested_if_is() == 42 then {
        print_line("test_nested_if_is: PASS")
    } else {
        print_line("test_nested_if_is: FAIL")
        return 1
    }
    
    print_line("All conditional pattern matching tests passed!")
    0
}
