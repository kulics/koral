// Test drop of lambda environment and captured values
// EXPECT: Creating Resource 1
// EXPECT: Closure created
// EXPECT: Calling closure
// EXPECT: Closure returned 1
// EXPECT: Drop Resource 1
// EXPECT: Creating Resource 2
// EXPECT: Closure with multiple captures created
// EXPECT: Calling multi-capture closure
// EXPECT: Multi-capture result: 5
// EXPECT: Drop Resource 2
// EXPECT: No-capture closure created
// EXPECT: No-capture result: 42
// EXPECT: All lambda env drop tests passed

type Resource(id Int)

given Resource {
    __drop(self ref) Void = {
        print("Drop Resource ")
        println(self.id)
    }
}

let test_single_capture() Void = {
    let r = Resource(1)
    println("Creating Resource 1")
    
    let closure = () -> {
        yield r.id
    }
    println("Closure created")
    
    println("Calling closure")
    let result = closure()
    print("Closure returned ")
    println(result)
    // closure goes out of scope here, should drop captured Resource
}

let test_multiple_captures() Void = {
    let r = Resource(2)
    println("Creating Resource 2")
    let x = 3
    
    let closure = () -> {
        yield r.id + x
    }
    println("Closure with multiple captures created")
    
    println("Calling multi-capture closure")
    let result = closure()
    print("Multi-capture result: ")
    println(result)
    // closure goes out of scope here, should drop captured Resource
}

let test_no_capture() Void = {
    let closure = () -> 42
    println("No-capture closure created")
    
    let result = closure()
    print("No-capture result: ")
    println(result)
    // No environment to drop
}

let main() Int = {
    test_single_capture()
    test_multiple_captures()
    test_no_capture()
    
    println("All lambda env drop tests passed")
    yield 0
}
