// Test drop of subject in if-pattern expressions (copy semantics)
// With copy semantics, both the binding (copy) and the subject (original) are dropped
// EXPECT: Creating Resource 1
// EXPECT: Pattern matched, id: 1
// EXPECT: Drop Resource 1
// EXPECT: Drop Resource 1
// EXPECT: Creating Resource 2
// EXPECT: Pattern did not match
// EXPECT: Drop Resource 2
// EXPECT: Creating Resource 3
// EXPECT: Drop Resource 3
// EXPECT: Drop Resource 3
// EXPECT: Got value: 3
// EXPECT: All if-pattern drop tests passed

type Resource(id Int)

given Resource {
    __drop(self ref) Void = {
        print("Drop Resource ")
        print_line(self.id)
    }
}

type MaybeResource {
    Some(r Resource),
    None(),
}

let create_some(id Int) MaybeResource = {
    print("Creating Resource ")
    print_line(id)
    MaybeResource.Some(Resource(id))
}

let create_none() MaybeResource = {
    MaybeResource.None()
}

let test_if_pattern_match() Void = {
    // Subject is rvalue, pattern matches
    // With copy semantics:
    // - r is a copy of the inner Resource
    // - r is dropped when scope ends
    // - subject (MaybeResource) is dropped after if-pattern, which drops the original Resource
    if create_some(1) is .Some(r) then {
        print("Pattern matched, id: ")
        print_line(r.id)
    }
}

let test_if_pattern_no_match() Void = {
    // Subject is rvalue, pattern does not match
    // No binding created, only subject is dropped
    if create_some(2) is .None then {
        print_line("This should not print")
    } else {
        print_line("Pattern did not match")
    }
}

let test_if_pattern_with_binding() Void = {
    // Subject is rvalue with binding
    // With copy semantics:
    // - r is a copy, dropped when scope ends
    // - subject is dropped after if expression
    let result = if create_some(3) is .Some(r) then {
        r.id
    } else {
        0
    }
    print("Got value: ")
    print_line(result)
}

let main() Int = {
    test_if_pattern_match()
    test_if_pattern_no_match()
    test_if_pattern_with_binding()
    
    print_line("All if-pattern drop tests passed")
    0
}
