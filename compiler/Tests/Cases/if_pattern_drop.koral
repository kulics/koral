// Test drop of subject in if-pattern expressions (borrow semantics)
// With borrow semantics, bindings are aliases into the subject â€” no copy, single drop
// EXPECT: Creating Resource 1
// EXPECT: Pattern matched, id: 1
// EXPECT: Drop Resource 1
// EXPECT: Creating Resource 2
// EXPECT: Pattern did not match
// EXPECT: Drop Resource 2
// EXPECT: Creating Resource 3
// EXPECT: Drop Resource 3
// EXPECT: Got value: 3
// EXPECT: All if-pattern drop tests passed

type Resource(id Int)

given Resource {
    __drop(self ref) Void = {
        print("Drop Resource ")
        println(self.id)
    }
}

type MaybeResource {
    Some(r Resource),
    None(),
}

let create_some(id Int) MaybeResource = {
    print("Creating Resource ")
    println(id)
    yield MaybeResource.Some(Resource(id))
}

let create_none() MaybeResource = {
    yield MaybeResource.None()
}

let test_if_pattern_match() Void = {
    // Subject is rvalue, pattern matches
    // With borrow semantics:
    // - r is an alias into the subject's inner Resource (no copy)
    // - subject (MaybeResource) is dropped after if-pattern, which drops the Resource
    if create_some(1) is .Some(r) then {
        print("Pattern matched, id: ")
        println(r.id)
    }
}

let test_if_pattern_no_match() Void = {
    // Subject is rvalue, pattern does not match
    // No binding created, only subject is dropped
    if create_some(2) is .None then {
        println("This should not print")
    } else {
        println("Pattern did not match")
    }
}

let test_if_pattern_with_binding() Void = {
    // Subject is rvalue with binding
    // With borrow semantics:
    // - r is an alias, no copy
    // - subject is dropped after if expression
    let result = if create_some(3) is .Some(r) then {
        yield r.id
    } else {
        yield 0
    }
    print("Got value: ")
    println(result)
}

let main() Int = {
    test_if_pattern_match()
    test_if_pattern_no_match()
    test_if_pattern_with_binding()
    
    println("All if-pattern drop tests passed")
    yield 0
}
