// EXPECT: All IO utils tests passed

using std.io.*

let main() Void = {
    // === copy_bytes ===
    let src1 = Buffer.from_string("copy me")
    let dst1 = Buffer.empty()
    let cr = copy_bytes(src1, dst1)
    when cr is {
        .Ok(n) then {
            assert(n == 7, "copy_bytes count")
            dst1.reset()
            let s = dst1.take_string()
            when s is {
                .Ok(v) then assert(v == "copy me", "copy_bytes content"),
                .Error(_) then assert(false, "copy_bytes string error"),
            }
        },
        .Error(_) then assert(false, "copy_bytes error"),
    }

    // === read_bytes ===
    let src2 = Buffer.from_string("read all")
    let rb = read_bytes(src2)
    when rb is {
        .Ok(buf) then {
            assert(buf.length() == 8, "read_bytes length")
            buf.reset()
            let s = buf.take_string()
            when s is {
                .Ok(v) then assert(v == "read all", "read_bytes content"),
                .Error(_) then assert(false, "read_bytes string error"),
            }
        },
        .Error(_) then assert(false, "read_bytes error"),
    }

    // === write_bytes ===
    let dst3 = Buffer.empty()
    let src3 = Buffer.from_string("write all")
    let wb = write_bytes(dst3, src3)
    when wb is {
        .Ok(_) then {
            dst3.reset()
            let s = dst3.take_string()
            when s is {
                .Ok(v) then assert(v == "write all", "write_bytes content"),
                .Error(_) then assert(false, "write_bytes string error"),
            }
        },
        .Error(_) then assert(false, "write_bytes error"),
    }

    // === write_bytes empty buf ===
    let dst4 = Buffer.empty()
    let empty = Buffer.empty()
    let wb2 = write_bytes(dst4, empty)
    when wb2 is {
        .Ok(_) then assert(dst4.length() == 0, "write_bytes empty"),
        .Error(_) then assert(false, "write_bytes empty error"),
    }

    // === copy_bytes empty source ===
    let src5 = Buffer.empty()
    let dst5 = Buffer.empty()
    let cr2 = copy_bytes(src5, dst5)
    when cr2 is {
        .Ok(n) then assert(n == 0, "copy_bytes empty count"),
        .Error(_) then assert(false, "copy_bytes empty error"),
    }

    print_line("All IO utils tests passed")
}
