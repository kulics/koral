// EXPECT: All IO utils tests passed

using * in "std/io"

let main() Void = {
    // === copy_bytes ===
    let src1 = ByteBuffer.from_string("copy me")
    let dst1 = ByteBuffer.zero()
    let cr = copy_all_bytes(src1, dst1)
    when cr in {
        .Ok(n) then {
            assert(n == 7, "copy_bytes count")
            dst1.seek(SeekPos.Start(0)).unwrap()
            let s = String.from_bytes(read_all_bytes(dst1).unwrap())
            assert(s == "copy me", "copy_bytes content")
        },
        .Error(_) then assert(false, "copy_bytes error"),
    }

    // === read_bytes ===
    let src2 = ByteBuffer.from_string("read all")
    let rb = read_all_bytes(src2)
    when rb in {
        .Ok(bytes) then {
            assert(bytes.count() == 8, "read_bytes length")
            let s = String.from_bytes(bytes)
            assert(s == "read all", "read_bytes content")
        },
        .Error(_) then assert(false, "read_bytes error"),
    }

    // === write_bytes ===
    let dst3 = ByteBuffer.zero()
    let src3 = "write all".to_bytes()
    let wb = write_all_bytes(dst3, src3, ....)
    when wb in {
        .Ok(_) then {
            dst3.seek(SeekPos.Start(0)).unwrap()
            let s = String.from_bytes(read_all_bytes(dst3).unwrap())
            assert(s == "write all", "write_bytes content")
        },
        .Error(_) then assert(false, "write_bytes error"),
    }

    // === write_bytes empty buf ===
    let dst4 = ByteBuffer.zero()
    let empty = [UInt8]List.new()
    let wb2 = write_all_bytes(dst4, empty, ....)
    when wb2 in {
        .Ok(_) then {
            dst4.seek(SeekPos.Start(0)).unwrap()
            assert(read_all_bytes(dst4).unwrap().count() == 0, "write_bytes empty")
        },
        .Error(_) then assert(false, "write_bytes empty error"),
    }

    // === copy_bytes empty source ===
    let src5 = ByteBuffer.zero()
    let dst5 = ByteBuffer.zero()
    let cr2 = copy_all_bytes(src5, dst5)
    when cr2 in {
        .Ok(n) then assert(n == 0, "copy_bytes empty count"),
        .Error(_) then assert(false, "copy_bytes empty error"),
    }

    println("All IO utils tests passed")
}
