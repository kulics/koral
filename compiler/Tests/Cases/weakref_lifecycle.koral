// EXPECT: WeakRef Lifecycle Test:
// EXPECT: Initial strong count: 1
// EXPECT: Upgrade before release: true
// EXPECT: Value before release: 100
// EXPECT: Upgrade after release: false
// EXPECT: Test passed!

let testWeakRefLifecycle() Int = {
    print_line("WeakRef Lifecycle Test:")
    
    // Create a weak reference that will outlive the strong reference
    let weakRef Int weakref = {
        let strongRef Int ref = ref 100
        
        let count = ref_count(strongRef)
        print("Initial strong count: ")
        print_line(count)
        
        // Downgrade to weak reference
        let w = downgrade_ref(strongRef)
        
        // Upgrade should succeed while strong ref exists
        let upgraded_opt = upgrade_ref(w)
        when upgraded_opt is {
            .Some(upgraded) then {
                print_line("Upgrade before release: true")
                print("Value before release: ")
                print_line(deref upgraded)
            },
            .None then {
                print_line("Upgrade before release: false")
            },
        }
        
        // Return the weak reference - strong ref will be released
        w
    }
    
    // Now the strong reference is released
    // Upgrade should fail
    let upgraded_opt2 = upgrade_ref(weakRef)
    when upgraded_opt2 is {
        .Some(_) then {
            print_line("Upgrade after release: true")
        },
        .None then {
            print_line("Upgrade after release: false")
        },
    }
    
    print_line("Test passed!")
    0
}

let main() Int = {
    testWeakRefLifecycle()
    0
}
