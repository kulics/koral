// EXPECT: WeakRef Lifecycle Test:
// EXPECT: Initial strong count: 1
// EXPECT: Upgrade before release: true
// EXPECT: Value before release: 100
// EXPECT: Upgrade after release: false
// EXPECT: Test passed!

let testWeakRefLifecycle() Int = {
    println("WeakRef Lifecycle Test:")
    
    // Create a weak reference that will outlive the strong reference
    let weakRef Int weakref = {
        let strongRef Int ref = ref 100
        
        let count = ref_count(strongRef)
        print("Initial strong count: ")
        println(count)
        
        // Downgrade to weak reference
        let w = downgrade_ref(strongRef)
        
        // Upgrade should succeed while strong ref exists
        let upgraded_opt = upgrade_ref(w)
        when upgraded_opt is {
            .Some(upgraded) then {
                println("Upgrade before release: true")
                print("Value before release: ")
                println(deref upgraded)
            },
            .None then {
                println("Upgrade before release: false")
            },
        }
        
        // Return the weak reference - strong ref will be released
        yield w
    }
    
    // Now the strong reference is released
    // Upgrade should fail
    let upgraded_opt2 = upgrade_ref(weakRef)
    when upgraded_opt2 is {
        .Some(_) then {
            println("Upgrade after release: true")
        },
        .None then {
            println("Upgrade after release: false")
        },
    }
    
    println("Test passed!")
    yield 0
}

let main() Int = {
    testWeakRefLifecycle()
    yield 0
}
