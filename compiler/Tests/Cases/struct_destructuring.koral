// Test struct destructuring patterns
// EXPECT: test_when_basic: PASS
// EXPECT: test_when_nested: PASS
// EXPECT: test_if_is_basic: PASS
// EXPECT: test_if_is_with_else: PASS
// EXPECT: test_while_is: PASS
// EXPECT: test_and_combinator: PASS
// EXPECT: test_or_combinator: PASS
// EXPECT: test_wildcard_fields: PASS
// EXPECT: test_literal_field: PASS
// EXPECT: test_exhaustiveness: PASS
// EXPECT: All struct destructuring tests passed!

type Point(x Int, y Int)
type Rect(origin Point, width Int, height Int)

type MyOption {
    None(),
    Some(val Int),
}

// Test 1: Basic struct destructuring in when expression
let test_when_basic() Int = {
    let p = Point(10, 20)
    yield when p is {
        Point(x, y) then x + y,
    }
}

// Test 2: Nested struct destructuring in when expression
let test_when_nested() Int = {
    let r = Rect(Point(1, 2), 30, 40)
    yield when r is {
        Rect(Point(a, b), w, h) then a + b + w + h,
    }
}

// Test 3: Struct destructuring in if...is expression
let test_if_is_basic() Int = {
    let p = Point(5, 10)
    yield if p is Point(x, y) then x * y else 0
}

// Test 4: Struct destructuring in if...is with else branch
let test_if_is_with_else() Int = {
    let p = Point(3, 7)
    yield if p is Point(x, y) then x + y else 0
}

// Test 5: Struct destructuring in while...is expression
let test_while_is() Int = {
    let mut sum = 0
    let mut i = 0
    let points = [Point]List.new()
    // Use a simple counter-based approach instead
    let p1 = Point(1, 2)
    let p2 = Point(3, 4)
    // Test with if...is in a loop
    if p1 is Point(x, y) then {
        sum = sum + x + y
    }
    if p2 is Point(x, y) then {
        sum = sum + x + y
    }
    yield sum  // 1+2+3+4 = 10
}

// Test 6: Struct destructuring with and combinator
let test_and_combinator() Int = {
    let p = Point(5, 10)
    yield when p is {
        Point(x, y) and Point(a, b) then x + b,
    }
}

// Test 7: Struct destructuring with or combinator
let test_or_combinator() Int = {
    let x = 42
    yield when x is {
        0 or 1 then 0,
        n then n,
    }
}

// Test 8: Struct destructuring with wildcard fields
let test_wildcard_fields() Int = {
    let p = Point(7, 13)
    yield when p is {
        Point(_, y) then y,
    }
}

// Test 9: Struct destructuring with literal field match
let test_literal_field() Int = {
    let p = Point(0, 42)
    yield when p is {
        Point(0, y) then y,
        Point(x, _) then x,
    }
}

// Test 10: Struct destructuring exhaustiveness (single struct pattern covers all)
let test_exhaustiveness() Int = {
    let p = Point(3, 4)
    yield when p is {
        Point(x, y) then x + y,
    }
}

let main() Int = {
    if test_when_basic() == 30 then {
        print_line("test_when_basic: PASS")
    } else {
        print_line("test_when_basic: FAIL")
        return 1
    }

    if test_when_nested() == 73 then {
        print_line("test_when_nested: PASS")
    } else {
        print_line("test_when_nested: FAIL")
        return 1
    }

    if test_if_is_basic() == 50 then {
        print_line("test_if_is_basic: PASS")
    } else {
        print_line("test_if_is_basic: FAIL")
        return 1
    }

    if test_if_is_with_else() == 10 then {
        print_line("test_if_is_with_else: PASS")
    } else {
        print_line("test_if_is_with_else: FAIL")
        return 1
    }

    if test_while_is() == 10 then {
        print_line("test_while_is: PASS")
    } else {
        print_line("test_while_is: FAIL")
        return 1
    }

    if test_and_combinator() == 15 then {
        print_line("test_and_combinator: PASS")
    } else {
        print_line("test_and_combinator: FAIL")
        return 1
    }

    if test_or_combinator() == 42 then {
        print_line("test_or_combinator: PASS")
    } else {
        print_line("test_or_combinator: FAIL")
        return 1
    }

    if test_wildcard_fields() == 13 then {
        print_line("test_wildcard_fields: PASS")
    } else {
        print_line("test_wildcard_fields: FAIL")
        return 1
    }

    if test_literal_field() == 42 then {
        print_line("test_literal_field: PASS")
    } else {
        print_line("test_literal_field: FAIL")
        return 1
    }

    if test_exhaustiveness() == 7 then {
        print_line("test_exhaustiveness: PASS")
    } else {
        print_line("test_exhaustiveness: FAIL")
        return 1
    }

    print_line("All struct destructuring tests passed!")
    yield 0
}
