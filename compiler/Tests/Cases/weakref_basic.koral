// EXPECT: WeakRef Basic Test:
// EXPECT: Strong ref count: 1
// EXPECT: After downgrade, strong count: 1
// EXPECT: Upgrade succeeded: true
// EXPECT: Upgraded value: 42
// EXPECT: Test passed!

let testWeakRefBasic() Int = {
    // Create a strong reference
    let strongRef Int ref = ref 42
    
    print_line("WeakRef Basic Test:")
    
    // Check initial ref count
    let count1 = ref_count(strongRef)
    print("Strong ref count: ")
    print_line(count1)
    
    // Downgrade to weak reference
    let weakRef Int weakref = downgrade_ref(strongRef)
    
    // Strong count should still be 1
    let count2 = ref_count(strongRef)
    print("After downgrade, strong count: ")
    print_line(count2)
    
    // Upgrade weak reference back to strong
    let upgraded_opt = upgrade_ref(weakRef)
    when upgraded_opt is {
        .Some(upgraded) then {
            print_line("Upgrade succeeded: true")
            print("Upgraded value: ")
            print_line(deref upgraded)
        },
        .None then {
            print_line("Upgrade succeeded: false")
        },
    }
    
    print_line("Test passed!")
    yield 0
}

let main() Int = {
    testWeakRefBasic()
    yield 0
}
