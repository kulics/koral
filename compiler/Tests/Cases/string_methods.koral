// EXPECT: String advanced tests passed

let expect_some_int(opt [Int]Option, v Int, msg String) Void = {
    when opt is {
        .Some(x) then assert(x == v, msg),
        .None then panic(msg),
    }
}

let test_capacity_and_empty() Void = {
    let s = "abc"
    assert(s.capacity_byte() >= s.count_byte(), "capacity")
    let e = String.empty()
    assert(e.count_byte() == 0, "empty count")
    assert(e.is_empty(), "empty flag")
}

let test_prefix_suffix_and_bytes() Void = {
    let s = "abcab"
    assert(s.starts_with("ab"), "starts_with")
    assert(s.ends_with("ab"), "ends_with")
    assert(s.contains_byte(99), "contains_byte")
    expect_some_int(s.first_index_of_byte(98), 1, "first index b")
    expect_some_int(s.last_index_of_byte(98), 4, "last index b")
}

let test_trim_and_case() Void = {
    let s = "  HeLLo  "
    let trimmed = s.trim_ascii_whitespace()
    assert(trimmed == "HeLLo", "trim both")
    assert(trimmed.trim_ascii_start() == "HeLLo", "trim start")
    assert(trimmed.trim_ascii_end() == "HeLLo", "trim end")
    assert(trimmed.to_ascii_lowercase() == "hello", "lowercase")
    assert(trimmed.to_ascii_uppercase() == "HELLO", "uppercase")
    assert("hELlo  woRLD".to_ascii_title() == "Hello  World", "title")
}

let test_insert_remove_pop() Void = {
    let mut s = "ac"
    s.insert_byte(1, 98) // insert 'b'
    assert(s == "abc", "insert")
    let removed = s.remove_byte(1)
    assert(removed == 98, "remove return")
    assert(s == "ac", "remove result")
    let popd = s.pop_byte()
    when popd is { .Some(v) then assert(v == 99, "pop value"), .None then panic("pop none"), }
    assert(s == "a", "pop shrinks")
}

let test_find_contains_replace_repeat() Void = {
    let s = "ababa"
    expect_some_int(s.find("aba"), 0, "find aba")
    expect_some_int(s.find_from("aba", 1), 2, "find_from aba")
    assert(s.contains("ba"), "contains ba")
    assert(s.count_string("aba") == 1, "count string")
    let r = "abcabc".replace("ab", "X")
    assert(r == "XcXc", "replace")
    let rep = "ab".repeat(3)
    assert(rep == "ababab", "repeat")
}

let test_ascii_checks() Void = {
    let s = "azAZ09"
    assert(s.is_ascii(), "ascii")
    let mut ws = " \t"// space and tab
    assert(ws.is_ascii_blank(), "blank yes")
    let a UInt8 = 97// 'a'
    ws.push_byte(a)
    assert(not ws.is_ascii_blank(), "blank no")
}

let test_substring_and_remove_prefix_suffix() Void = {
    let s = "abcdef"
    assert(s.substring(2, 3) == "cde", "substring")
    assert(s.remove_prefix("ab") == "cdef", "remove prefix")
    assert(s.remove_suffix("ef") == "abcd", "remove suffix")
}

let test_split_whitespace() Void = {
    let s = "  a  bc d  "
    let mut it = s.split_ascii_whitespace()
    let mut acc = String.empty()
    let mut first = true
    let mut done = false
    while not done then {
        let n = it.next()
        when n is {
            .Some(part) then {
                if not first then { acc.push_byte(44) } // comma
                first = false
                acc.push(part)
            },
            .None then { done = true },
        }
    }
    assert(acc == "a,bc,d", "split ascii whitespace")
}

let test_split_sep_and_lines() Void = {
    let s = "a--b--"
    let mut it = s.split("--")
    let mut parts = String.empty()
    let mut first = true
    let mut done = false
    while not done then {
        let n = it.next()
        when n is {
            .Some(p) then {
                if not first then { parts.push_byte(58) } // ':'
                first = false
                parts.push(p)
            },
            .None then { done = true },
        }
    }
    assert(parts == "a:b:", "split sep includes trailing empty")

    let l = "x\ny\n"
    let mut lit = l.lines()
    let mut out = String.empty()
    let mut firstLine = true
    let mut done2 = false
    while not done2 then {
        let n = lit.next()
        when n is {
            .Some(line) then {
                if not firstLine then { out.push_byte(59) } // ';'
                firstLine = false
                out.push(line)
            },
            .None then { done2 = true },
        }
    }
    assert(out == "x;y", "lines split")
}

let main() Void = {
    test_capacity_and_empty()
    test_prefix_suffix_and_bytes()
    test_trim_and_case()
    test_insert_remove_pop()
    test_find_contains_replace_repeat()
    test_ascii_checks()
    test_substring_and_remove_prefix_suffix()
    test_split_whitespace()
    test_split_sep_and_lines()
    print_string("String advanced tests passed")
}
