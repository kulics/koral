// EXPECT: All BufWriter tests passed

using std.io.*

let main() Void = {
    // === write + flush ===
    let dst1 = Buffer.empty()
    let w1 = [Buffer]BufWriter.new(dst1)
    let ws1 = w1.write_string("hello")
    when ws1 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_string error"),
    }
    let f1 = w1.flush()
    when f1 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush error"),
    }
    dst1.reset()
    let s1 = dst1.take_string()
    when s1 is {
        .Ok(v) then assert(v == "hello", "flush content"),
        .Error(_) then assert(false, "take_string error"),
    }

    // === write_byte ===
    let dst2 = Buffer.empty()
    let w2 = [Buffer]BufWriter.new(dst2)
    let wb1 = w2.write_byte(65)
    when wb1 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_byte error"),
    }
    let wb2 = w2.write_byte(66)
    when wb2 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_byte 2 error"),
    }
    let f2 = w2.flush()
    when f2 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 2 error"),
    }
    dst2.reset()
    let s2 = dst2.take_string()
    when s2 is {
        .Ok(v) then assert(v == "AB", "write_byte content"),
        .Error(_) then assert(false, "take_string 2 error"),
    }

    // === write_line ===
    let dst3 = Buffer.empty()
    let w3 = [Buffer]BufWriter.new(dst3)
    let wl = w3.write_line("line1")
    when wl is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_line error"),
    }
    let f3 = w3.flush()
    when f3 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 3 error"),
    }
    dst3.reset()
    let s3 = dst3.take_string()
    when s3 is {
        .Ok(v) then assert(v == "line1\n", "write_line content"),
        .Error(_) then assert(false, "take_string 3 error"),
    }

    // === write_rune (ASCII) ===
    let dst4 = Buffer.empty()
    let w4 = [Buffer]BufWriter.new(dst4)
    let wr1 = w4.write_rune(Rune(65))
    when wr1 is {
        .Ok(n) then assert(n == 1, "write_rune ASCII bytes"),
        .Error(_) then assert(false, "write_rune error"),
    }
    let f4 = w4.flush()
    when f4 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 4 error"),
    }
    dst4.reset()
    assert(dst4.take_byte().unwrap() == 65, "write_rune ASCII value")

    // === write_rune (2-byte: é = U+00E9) ===
    let dst5 = Buffer.empty()
    let w5 = [Buffer]BufWriter.new(dst5)
    let wr2 = w5.write_rune(Rune(233))
    when wr2 is {
        .Ok(n) then assert(n == 2, "write_rune 2-byte count"),
        .Error(_) then assert(false, "write_rune 2-byte error"),
    }
    let f5 = w5.flush()
    when f5 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 5 error"),
    }
    assert(dst5.count() == 2, "write_rune 2-byte length")

    // === write_rune (3-byte: 中 = U+4E2D) ===
    let dst5b = Buffer.empty()
    let w5b = [Buffer]BufWriter.new(dst5b)
    let wr2b = w5b.write_rune(Rune(20013))
    when wr2b is {
        .Ok(n) then assert(n == 3, "write_rune 3-byte count"),
        .Error(_) then assert(false, "write_rune 3-byte error"),
    }
    let f5b = w5b.flush()
    when f5b is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 5b error"),
    }
    assert(dst5b.count() == 3, "write_rune 3-byte length")

    // === auto-flush (small capacity) ===
    let dst6 = Buffer.empty()
    let w6 = [Buffer]BufWriter.with_capacity(dst6, 4)
    let mut i Int = 0
    while i < 5 then {
        let wr = w6.write_byte((UInt8)(65 + i))
        when wr is {
            .Ok(_) then {},
            .Error(_) then assert(false, "auto-flush write error"),
        }
        i += 1
    }
    let f6 = w6.flush()
    when f6 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 6 error"),
    }
    assert(dst6.count() == 5, "auto-flush total length")
    dst6.reset()
    let s6 = dst6.take_string()
    when s6 is {
        .Ok(v) then assert(v == "ABCDE", "auto-flush content"),
        .Error(_) then assert(false, "auto-flush take_string error"),
    }

    // === multiple write_string + flush ===
    let dst7 = Buffer.empty()
    let w7 = [Buffer]BufWriter.new(dst7)
    let _ = w7.write_string("foo")
    let _ = w7.write_string("bar")
    let _ = w7.write_string("baz")
    let f7 = w7.flush()
    when f7 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 7 error"),
    }
    dst7.reset()
    let s7 = dst7.take_string()
    when s7 is {
        .Ok(v) then assert(v == "foobarbaz", "multi write content"),
        .Error(_) then assert(false, "multi write error"),
    }

    println("All BufWriter tests passed")
}
