// EXPECT: All BufWriter tests passed

using * in "std/io"

let main() Void = {
    // === write + flush ===
    let dst1 = ByteBuffer.zero()
    let w1 = [ByteBuffer]BufWriter.new(dst1)
    let ws1 = w1.write_string("hello")
    when ws1 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_string error"),
    }
    let f1 = w1.flush()
    when f1 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush error"),
    }

    // === write_byte ===
    let dst2 = ByteBuffer.zero()
    let w2 = [ByteBuffer]BufWriter.new(dst2)
    let wb1 = w2.write_byte(65)
    when wb1 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_byte error"),
    }
    let wb2 = w2.write_byte(66)
    when wb2 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_byte 2 error"),
    }
    let f2 = w2.flush()
    when f2 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 2 error"),
    }

    // === write_line ===
    let dst3 = ByteBuffer.zero()
    let w3 = [ByteBuffer]BufWriter.new(dst3)
    let wl = w3.write_line("line1")
    when wl in {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_line error"),
    }
    let f3 = w3.flush()
    when f3 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 3 error"),
    }

    // === write_rune (ASCII) ===
    let dst4 = ByteBuffer.zero()
    let w4 = [ByteBuffer]BufWriter.new(dst4)
    let wr1 = w4.write_rune(Rune(65))
    when wr1 in {
        .Ok(n) then assert(n == 1, "write_rune ASCII bytes"),
        .Error(_) then assert(false, "write_rune error"),
    }
    let f4 = w4.flush()
    when f4 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 4 error"),
    }

    // === write_rune (2-byte: é = U+00E9) ===
    let dst5 = ByteBuffer.zero()
    let w5 = [ByteBuffer]BufWriter.new(dst5)
    let wr2 = w5.write_rune(Rune(233))
    when wr2 in {
        .Ok(n) then assert(n == 2, "write_rune 2-byte count"),
        .Error(_) then assert(false, "write_rune 2-byte error"),
    }
    let f5 = w5.flush()
    when f5 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 5 error"),
    }

    // === write_rune (3-byte: 中 = U+4E2D) ===
    let dst5b = ByteBuffer.zero()
    let w5b = [ByteBuffer]BufWriter.new(dst5b)
    let wr2b = w5b.write_rune(Rune(20013))
    when wr2b in {
        .Ok(n) then assert(n == 3, "write_rune 3-byte count"),
        .Error(_) then assert(false, "write_rune 3-byte error"),
    }
    let f5b = w5b.flush()
    when f5b in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 5b error"),
    }

    // === auto-flush (small capacity) ===
    let dst6 = ByteBuffer.zero()
    let w6 = [ByteBuffer]BufWriter.with_capacity(dst6, 4)
    let mut i Int = 0
    while i < 5 then {
        let wr = w6.write_byte((UInt8)(65 + i))
        when wr in {
            .Ok(_) then {},
            .Error(_) then assert(false, "auto-flush write error"),
        }
        i += 1
    }
    let f6 = w6.flush()
    when f6 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 6 error"),
    }

    // === multiple write_string + flush ===
    let dst7 = ByteBuffer.zero()
    let w7 = [ByteBuffer]BufWriter.new(dst7)
    let _ = w7.write_string("foo")
    let _ = w7.write_string("bar")
    let _ = w7.write_string("baz")
    let f7 = w7.flush()
    when f7 in {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 7 error"),
    }

    // === constrained Seeker impl (W: Writer and Seeker) ===
    let dst8 = ByteBuffer.zero()
    let w8 = [ByteBuffer]BufWriter.with_capacity(dst8, 16)
    w8.write_string("abc").unwrap()
    let pos8 = w8.seek(SeekPos.Start(0)).unwrap()
    assert(pos8 == (UInt64)0, "bufwriter seek returns position")
    w8.flush().unwrap()
    dst8.seek(SeekPos.Start(0)).unwrap()
    let mut out8 = make_bytes(8)
    let n8 = dst8.read(ref out8, ....).unwrap()
    assert(n8 == 3, "bufwriter seek flushed pending bytes")
    assert(String.from_utf8_ptr(out8.borrow_ptr(), n8) == "abc", "bufwriter seek flush content")

    println("All BufWriter tests passed")
}
