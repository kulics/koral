// EXPECT: All BufWriter tests passed

using std.io.*

let main() Void = {
    // === write + flush ===
    let dst1 = ByteBuffer.zero()
    let w1 = [ByteBuffer]BufWriter.new(dst1)
    let ws1 = w1.write_string("hello")
    when ws1 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_string error"),
    }
    let f1 = w1.flush()
    when f1 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush error"),
    }

    // === write_byte ===
    let dst2 = ByteBuffer.zero()
    let w2 = [ByteBuffer]BufWriter.new(dst2)
    let wb1 = w2.write_byte(65)
    when wb1 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_byte error"),
    }
    let wb2 = w2.write_byte(66)
    when wb2 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_byte 2 error"),
    }
    let f2 = w2.flush()
    when f2 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 2 error"),
    }

    // === write_line ===
    let dst3 = ByteBuffer.zero()
    let w3 = [ByteBuffer]BufWriter.new(dst3)
    let wl = w3.write_line("line1")
    when wl is {
        .Ok(_) then {},
        .Error(_) then assert(false, "write_line error"),
    }
    let f3 = w3.flush()
    when f3 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 3 error"),
    }

    // === write_rune (ASCII) ===
    let dst4 = ByteBuffer.zero()
    let w4 = [ByteBuffer]BufWriter.new(dst4)
    let wr1 = w4.write_rune(Rune(65))
    when wr1 is {
        .Ok(n) then assert(n == 1, "write_rune ASCII bytes"),
        .Error(_) then assert(false, "write_rune error"),
    }
    let f4 = w4.flush()
    when f4 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 4 error"),
    }

    // === write_rune (2-byte: é = U+00E9) ===
    let dst5 = ByteBuffer.zero()
    let w5 = [ByteBuffer]BufWriter.new(dst5)
    let wr2 = w5.write_rune(Rune(233))
    when wr2 is {
        .Ok(n) then assert(n == 2, "write_rune 2-byte count"),
        .Error(_) then assert(false, "write_rune 2-byte error"),
    }
    let f5 = w5.flush()
    when f5 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 5 error"),
    }

    // === write_rune (3-byte: 中 = U+4E2D) ===
    let dst5b = ByteBuffer.zero()
    let w5b = [ByteBuffer]BufWriter.new(dst5b)
    let wr2b = w5b.write_rune(Rune(20013))
    when wr2b is {
        .Ok(n) then assert(n == 3, "write_rune 3-byte count"),
        .Error(_) then assert(false, "write_rune 3-byte error"),
    }
    let f5b = w5b.flush()
    when f5b is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 5b error"),
    }

    // === auto-flush (small capacity) ===
    let dst6 = ByteBuffer.zero()
    let w6 = [ByteBuffer]BufWriter.with_capacity(dst6, 4)
    let mut i Int = 0
    while i < 5 then {
        let wr = w6.write_byte((UInt8)(65 + i))
        when wr is {
            .Ok(_) then {},
            .Error(_) then assert(false, "auto-flush write error"),
        }
        i += 1
    }
    let f6 = w6.flush()
    when f6 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 6 error"),
    }

    // === multiple write_string + flush ===
    let dst7 = ByteBuffer.zero()
    let w7 = [ByteBuffer]BufWriter.new(dst7)
    let _ = w7.write_string("foo")
    let _ = w7.write_string("bar")
    let _ = w7.write_string("baz")
    let f7 = w7.flush()
    when f7 is {
        .Ok(_) then {},
        .Error(_) then assert(false, "flush 7 error"),
    }

    println("All BufWriter tests passed")
}
