// EXPECT: All Set tests passed

let main() Int = {
    // === Basic Operations ===
    let mut s = [Int]Set.new()
    assert(s.count() == 0, "new set count 0")
    assert(s.is_empty(), "new set is_empty")

    // === insert ===
    assert(s.insert(1), "insert new")
    assert(s.count() == 1, "count after insert")
    assert(not s.is_empty(), "not empty")

    s.insert(2);
    s.insert(3);
    assert(s.count() == 3, "count 3")

    // Insert duplicate
    assert(not s.insert(1), "insert duplicate returns false")
    assert(s.count() == 3, "count unchanged")

    // === contains ===
    assert(s.contains(1), "contains 1")
    assert(s.contains(2), "contains 2")
    assert(not s.contains(999), "not contains 999")

    // === remove ===
    assert(s.remove(2), "remove existing")
    assert(s.count() == 2, "count after remove")
    assert(not s.contains(2), "not contains after remove")
    assert(not s.remove(999), "remove missing")

    // === clear ===
    s.clear()
    assert(s.count() == 0, "count after clear")
    assert(s.is_empty(), "is_empty after clear")

    // === Rehash test ===
    let mut s2 = [Int]Set.new()
    let mut i = 0
    while i < 50 then {
        s2.insert(i);
        i = i + 1
    }
    assert(s2.count() == 50, "count after 50 inserts")

    i = 0
    while i < 50 then {
        assert(s2.contains(i), "contains after rehash")
        i = i + 1
    }

    // === iterator ===
    let mut s3 = [Int]Set.new()
    s3.insert(10);
    s3.insert(20);
    s3.insert(30);

    let mut count = 0
    let mut sum = 0
    let mut it = s3.iterator()
    while true then {
        when it.next() is {
            .Some(v) then {
                count = count + 1
                sum = sum + v
            },
            .None then { break; },
        }
    }
    assert(count == 3, "iterator count")
    assert(sum == 60, "iterator sum")

    // === Set operations ===
    let mut a = [Int]Set.new()
    a.insert(1);
    a.insert(2);
    a.insert(3);

    let mut b = [Int]Set.new()
    b.insert(2);
    b.insert(3);
    b.insert(4);

    // union
    let mut u = a.union(ref b)
    assert(u.count() == 4, "union count")
    assert(u.contains(1) and u.contains(2) and u.contains(3) and u.contains(4), "union values")

    // intersection
    let mut inter = a.intersection(ref b)
    assert(inter.count() == 2, "intersection count")
    assert(inter.contains(2) and inter.contains(3), "intersection values")
    assert(not inter.contains(1) and not inter.contains(4), "intersection excludes")

    // difference
    let mut diff = a.difference(ref b)
    assert(diff.count() == 1, "difference count")
    assert(diff.contains(1), "difference value")

    // === COW (Copy-On-Write) semantics ===
    let mut original = [Int]Set.new()
    original.insert(1);
    original.insert(2);

    let mut copy = original  // Shallow copy

    // Modify copy triggers COW
    copy.insert(3);
    copy.remove(1);

    // Original unchanged
    assert(original.count() == 2, "original count unchanged")
    assert(original.contains(1), "original contains 1")
    assert(not original.contains(3), "original not contains 3")

    // Copy modified
    assert(copy.count() == 2, "copy count")
    assert(not copy.contains(1), "copy not contains 1")
    assert(copy.contains(3), "copy contains 3")

    // === String set ===
    let mut ss = [String]Set.new()
    ss.insert("apple");
    ss.insert("banana");
    assert(ss.contains("apple"), "string set contains")
    assert(not ss.insert("apple"), "string set duplicate")

    // === insert_all ===
    let mut ia1 = [Int]Set.new()
    ia1.insert(1);
    ia1.insert(2);
    let mut ia2 = [Int]Set.new()
    ia2.insert(2);
    ia2.insert(3);
    ia2.insert(4);
    ia1.insert_all(ia2)
    assert(ia1.count() == 4, "insert_all count")
    assert(ia1.contains(1) and ia1.contains(2) and ia1.contains(3) and ia1.contains(4), "insert_all values")

    // insert_all empty set
    let mut ia3 = [Int]Set.new()
    ia3.insert(10);
    let ia_empty = [Int]Set.new()
    ia3.insert_all(ia_empty)
    assert(ia3.count() == 1, "insert_all empty no change")

    print_line("All Set tests passed")
    0
}
