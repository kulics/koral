// Test drop semantics for or else / and then with reference types
// EXPECT: or_else Some path
// EXPECT: Drop Resource 1
// EXPECT: Drop Resource 1
// EXPECT: or_else None path
// EXPECT: Drop Resource 2
// EXPECT: and_then Some path
// EXPECT: Drop Resource 3
// EXPECT: Drop Resource 3
// EXPECT: and_then None path

type Resource(id Int)

given Resource {
    __drop(self ref) Void = {
        print_line("Drop Resource " + self.id.to_string())
    }
}

let test_or_else_some() Void = {
    print_line("or_else Some path")
    let opt = [Resource]Option.Some(Resource(1))
    let val = opt or else Resource(99)
    // val is copy of Resource(1), opt's copy also drops
}

let test_or_else_none() Void = {
    print_line("or_else None path")
    let opt = [Resource]Option.None()
    let val = opt or else Resource(2)
    // val is Resource(2)
}

let test_and_then_some() Void = {
    print_line("and_then Some path")
    let opt = [Resource]Option.Some(Resource(3))
    let result = opt and then _
    // result is Some(copy of Resource(3)), opt's copy also drops
}

let test_and_then_none() Void = {
    print_line("and_then None path")
    let opt = [Resource]Option.None()
    let result = opt and then _
    // result is None, no Resource created
}

let main() Int = {
    test_or_else_some()
    test_or_else_none()
    test_and_then_some()
    test_and_then_none()
    yield 0
}
