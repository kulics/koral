// Test basic defer functionality
// Test 1: Single defer
// EXPECT: test_single_defer:
// EXPECT: before defer
// EXPECT: after defer
// EXPECT: deferred action
// Test 2: Multiple defers in LIFO order
// EXPECT: test_multiple_defer_lifo:
// EXPECT: first
// EXPECT: second
// EXPECT: third
// EXPECT: defer C
// EXPECT: defer B
// EXPECT: defer A
// Test 3: Defer executes before __drop
// EXPECT: test_defer_before_drop:
// EXPECT: created resource
// EXPECT: deferred cleanup
// EXPECT: Drop Resource 1

public type Resource(id Int)

given Resource {
    __drop(self ref) Void = {
        print("Drop Resource ")
        println(self.id)
    }
}

let test_single_defer() Void = {
    println("test_single_defer:")
    println("before defer")
    defer println("deferred action")
    println("after defer")
}

let test_multiple_defer_lifo() Void = {
    println("test_multiple_defer_lifo:")
    defer println("defer A")
    println("first")
    defer println("defer B")
    println("second")
    defer println("defer C")
    println("third")
}

let test_defer_before_drop() Void = {
    println("test_defer_before_drop:")
    let r = Resource(1)
    println("created resource")
    defer println("deferred cleanup")
}

public let main() Int = {
    test_single_defer()
    test_multiple_defer_lifo()
    test_defer_before_drop()
    yield 0
}
