// Test basic defer functionality
// Test 1: Single defer
// EXPECT: test_single_defer:
// EXPECT: before defer
// EXPECT: after defer
// EXPECT: deferred action
// Test 2: Multiple defers in LIFO order
// EXPECT: test_multiple_defer_lifo:
// EXPECT: first
// EXPECT: second
// EXPECT: third
// EXPECT: defer C
// EXPECT: defer B
// EXPECT: defer A
// Test 3: Defer executes before __drop
// EXPECT: test_defer_before_drop:
// EXPECT: created resource
// EXPECT: deferred cleanup
// EXPECT: Drop Resource 1

public type Resource(id Int)

given Resource {
    __drop(self ref) Void = {
        print("Drop Resource ")
        print_line(self.id)
    }
}

let test_single_defer() Void = {
    print_line("test_single_defer:")
    print_line("before defer")
    defer print_line("deferred action")
    print_line("after defer")
}

let test_multiple_defer_lifo() Void = {
    print_line("test_multiple_defer_lifo:")
    defer print_line("defer A")
    print_line("first")
    defer print_line("defer B")
    print_line("second")
    defer print_line("defer C")
    print_line("third")
}

let test_defer_before_drop() Void = {
    print_line("test_defer_before_drop:")
    let r = Resource(1)
    print_line("created resource")
    defer print_line("deferred cleanup")
}

public let main() Int = {
    test_single_defer()
    test_multiple_defer_lifo()
    test_defer_before_drop()
    yield 0
}
