// Test basic Stream API functionality

let main() Void = {
    // Test with List
    let mut list = [Int]List.new()
    list.push_back(1)
    list.push_back(2)
    list.push_back(3)
    list.push_back(4)
    list.push_back(5)
    
    // Test filter (chained)
    let filtered = [Int, [Int]ListIterator]Stream(list.iterator()).filter((x) -> x > 2).to_list()
    print("Filtered (>2): ")
    print_list(filtered)
    
    // Test map (chained)
    let mapped = [Int, [Int]ListIterator]Stream(list.iterator()).[Int]map((x) -> x * 2).to_list()
    print("Mapped (*2): ")
    print_list(mapped)
    
    // Test filter + map chain
    let chained = [Int, [Int]ListIterator]Stream(list.iterator()).filter((x) -> x > 2).[Int]map((x) -> x * 10).to_list()
    print("Chained (>2, *10): ")
    print_list(chained)
    
    // Test take (chained)
    let taken = [Int, [Int]ListIterator]Stream(list.iterator()).take(3).to_list()
    print("Take 3: ")
    print_list(taken)
    
    // Test skip (chained)
    let skipped = [Int, [Int]ListIterator]Stream(list.iterator()).skip(2).to_list()
    print("Skip 2: ")
    print_list(skipped)
    
    // Test count
    let cnt = [Int, [Int]ListIterator]Stream(list.iterator()).count()
    print("Count: ")
    print_line(cnt.to_string())
    
    // Test first
    when [Int, [Int]ListIterator]Stream(list.iterator()).first() is {
        .Some(v) then { print("First: "); print_line(v.to_string()); },
        .None then { print_line("First: None"); },
    }
    
    // Test last
    when [Int, [Int]ListIterator]Stream(list.iterator()).last() is {
        .Some(v) then { print("Last: "); print_line(v.to_string()); },
        .None then { print_line("Last: None"); },
    }
    
    // Test at
    when [Int, [Int]ListIterator]Stream(list.iterator()).at(2) is {
        .Some(v) then { print("At 2: "); print_line(v.to_string()); },
        .None then { print_line("At 2: None"); },
    }
    
    // Test fold
    let sum = [Int, [Int]ListIterator]Stream(list.iterator()).[Int]fold(0, (acc, x) -> acc + x)
    print("Sum (fold): ")
    print_line(sum.to_string())
    
    // Test reduce
    when [Int, [Int]ListIterator]Stream(list.iterator()).reduce((a, b) -> a + b) is {
        .Some(v) then { print("Sum (reduce): "); print_line(v.to_string()); },
        .None then { print_line("Sum (reduce): None"); },
    }
    
    // Test step
    let stepped = [Int, [Int]ListIterator]Stream(list.iterator()).step(2).to_list()
    print("Step 2: ")
    print_list(stepped)
    
    // Test enumerate
    let enumerated = [Int, [Int]ListIterator]Stream(list.iterator()).enumerate().to_list()
    print("Enumerate: ")
    print_indexed_list(enumerated)
    
    // Test peek (just verify it doesn't modify elements)
    let peeked = [Int, [Int]ListIterator]Stream(list.iterator()).peek((x) -> { print(""); }).to_list()
    print("Peek count: ")
    print_line(peeked.count().to_string())
    
    // Test take_while
    let taken_while = [Int, [Int]ListIterator]Stream(list.iterator()).take_while((x) -> x < 4).to_list()
    print("TakeWhile (<4): ")
    print_list(taken_while)
    
    // Test skip_while
    let skipped_while = [Int, [Int]ListIterator]Stream(list.iterator()).skip_while((x) -> x < 3).to_list()
    print("SkipWhile (<3): ")
    print_list(skipped_while)
    
    // Test separate
    let mut small_list = [Int]List.new()
    small_list.push_back(1)
    small_list.push_back(2)
    small_list.push_back(3)
    let separated = [Int, [Int]ListIterator]Stream(small_list.iterator()).separate(0).to_list()
    print("Separate with 0: ")
    print_list(separated)
    
    print_line("All tests passed!")
}

let print_list(list [Int]List) Void = {
    print("[")
    let mut i = 0
    while i < list.count() then {
        if i > 0 then { print(", "); }
        print(list[i].to_string())
        i += 1
    }
    print_line("]")
}

let print_indexed_list(list [[Int]Indexed]List) Void = {
    print("[")
    let mut i = 0
    while i < list.count() then {
        if i > 0 then { print(", "); }
        let item = list[i]
        print("(")
        print(item.index.to_string())
        print(", ")
        print(item.value.to_string())
        print(")")
        i += 1
    }
    print_line("]")
}

// EXPECT: Filtered (>2): [3, 4, 5]
// EXPECT: Mapped (*2): [2, 4, 6, 8, 10]
// EXPECT: Chained (>2, *10): [30, 40, 50]
// EXPECT: Take 3: [1, 2, 3]
// EXPECT: Skip 2: [3, 4, 5]
// EXPECT: Count: 5
// EXPECT: First: 1
// EXPECT: Last: 5
// EXPECT: At 2: 3
// EXPECT: Sum (fold): 15
// EXPECT: Sum (reduce): 15
// EXPECT: Step 2: [1, 3, 5]
// EXPECT: Enumerate: [(0, 1), (1, 2), (2, 3), (3, 4), (4, 5)]
// EXPECT: Peek count: 5
// EXPECT: TakeWhile (<4): [1, 2, 3]
// EXPECT: SkipWhile (<3): [3, 4, 5]
// EXPECT: Separate with 0: [1, 0, 2, 0, 3]
// EXPECT: All tests passed!
