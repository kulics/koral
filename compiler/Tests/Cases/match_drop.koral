// Test drop in match expressions (borrow semantics)
// With borrow semantics, bindings are aliases â€” no copy, single drop for rvalue subjects
// Lvalue subjects are dropped by their own scope
// EXPECT: Start Struct Move
// EXPECT: Inside Match
// EXPECT: End Struct Move
// EXPECT: Drop Resource
// EXPECT: 1
// EXPECT: Start Enum Move
// EXPECT: Inside Match
// EXPECT: End Enum Move
// EXPECT: Drop Resource
// EXPECT: 2
// EXPECT: Start Ref Copy
// EXPECT: Inside Match
// EXPECT: After Match
// EXPECT: Drop Resource
// EXPECT: 3

type Resource(id Int)

given Resource {
  __drop(self ref) Void = {
      println("Drop Resource")
      println(self.id)
  }
}

// 1. Struct Borrow Test
type Wrapper(r Resource)

let test_struct_borrow() Void = {
    println("Start Struct Move")
    let w = Wrapper(Resource(1))
    when w in {
        // w_moved is an alias into w (no copy)
        w_moved then {
            println("Inside Match")
        },
    }
    println("End Struct Move")
    // w (original) drops here at end of function scope
}

// 2. Enum Borrow Test
type Container {
    Item(r Resource),
    Empty(),
}

let test_enum_borrow() Void = {
    println("Start Enum Move")
    let c = Container.Item(Resource(2))
    when c in {
        .Item(r_inner) then {
            // r_inner is an alias into c's inner Resource (no copy)
            println("Inside Match")
        },
        .Empty then {},
    }
    println("End Enum Move")
    // c (original) drops here at end of function scope
}

// 3. Ref Borrow Test
let test_ref_borrow() Void = {
    println("Start Ref Copy")
    let r = ref Resource(3)
    
    when r in {
        x then {
             println("Inside Match")
        },
    }
    
    println("After Match")
    // r drops here (ref count dec to 0, Resource destroyed)
}

let main() Void = {
    test_struct_borrow()
    test_enum_borrow()
    test_ref_borrow()
}
