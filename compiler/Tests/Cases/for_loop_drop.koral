// Test drop of iterator and elements in for loops (borrow semantics)
// With borrow semantics, the element binding is an alias into the match subject
// The match subject (result of next()) is dropped once per iteration
// EXPECT: Creating list
// EXPECT: Iteration: 0
// EXPECT: Drop Element 0
// EXPECT: Iteration: 1
// EXPECT: Drop Element 1
// EXPECT: Iteration: 2
// EXPECT: Drop Element 2
// EXPECT: Loop ended
// EXPECT: Break test start
// EXPECT: Iteration: 0
// EXPECT: Drop Element 0
// EXPECT: Breaking at 1
// EXPECT: After break
// EXPECT: All for loop drop tests passed

type Element(id Int)

given Element {
    __drop(self ref) Void = {
        print("Drop Element ")
        println(self.id)
    }
}

let test_for_loop_basic() Void = {
    println("Creating list")
    let mut list = [Element]List.new()
    list.push(Element(0))
    list.push(Element(1))
    list.push(Element(2))
    
    for e = list then {
        print("Iteration: ")
        println(e.id)
    }
    
    println("Loop ended")
}

let test_for_loop_break() Void = {
    println("Break test start")
    let mut list = [Element]List.new()
    list.push(Element(0))
    list.push(Element(1))
    list.push(Element(2))
    
    for e = list then {
        print("Iteration: ")
        println(e.id)
        if e.id == 1 then {
            println("Breaking at 1")
            break
        }
    }
    println("After break")
}

let main() Int = {
    test_for_loop_basic()
    test_for_loop_break()
    
    println("All for loop drop tests passed")
    yield 0
}
